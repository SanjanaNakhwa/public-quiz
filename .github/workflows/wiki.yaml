name: wiki 
on:
  gollum:
permissions:
  pages: write
  contents: read
  id-token: write
concurrency:
  group: secret-tv-access
  cancel-in-progress: true
jobs:
  client:
    setup:
      - name: Create Environment
        run: |
          curl \
          -X PUT \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{github.token}}" \
          $ROOT/repos/$REPO/environments/$STAGE
        env:
          ROOT: "https://api.github.com"
          REPO: ${{ github.repository }}
          STAGE: "secret-tv-access"
      - id: client
        name: Read client ID
        run: |
          JSON=$(curl \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{github.token}}" \
          $ROOT/repos/$REPO);
          CLIENT=$(jq -r '.description' <<< $JSON);
          echo "Using OAuth App $CLIENT";
          echo "client=$CLIENT" >> $GITHUB_OUTPUT
        env:
          ROOT: "https://api.github.com"
          REPO: ${{ github.repository }}
    outputs:
      client: ${{ steps.client.outputs.client }}
  get-code:
    needs: [setup]
    uses: ./.github/workflows/activate.yaml
    with:
      client: ${{ needs.setup.outputs.client }}
      step: 0
    secrets:
      token: ${{ github.token }}
  push-code:
    needs: [get-code]
    uses: ./.github/workflows/pages.yaml
    with:
      contents: ${{ needs.get-code.outputs.text }}
  get-token:
    needs: [push-code]
    uses: ./.github/workflows/activate.yaml
    with:
      client: ${{ needs.setup.outputs.client }}
      step: 1
    secrets:
      token: ${{ github.token }}
  push-token:
    needs: [get-token]
    uses: ./.github/workflows/pages.yaml
    with:
      contents: ${{ needs.get-code.outputs.text }}
